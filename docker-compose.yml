version: '3.8'

services:
  postgres-backup:
    image: postgres:16-alpine
    container_name: postgres-backup
    restart: unless-stopped
    environment:
      PGHOST: ${POSTGRES_HOST}
      PGPORT: ${POSTGRES_PORT:-5432}
      PGDATABASE: ${POSTGRES_DB}
      PGUSER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      TZ: ${TZ:-Europe/Istanbul}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-7}
    volumes:
      - postgres-backups:/backups
      - ./scripts:/scripts:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        cp /scripts/backup-postgres.sh /usr/local/bin/backup-postgres.sh
        chmod +x /usr/local/bin/backup-postgres.sh

        echo "========================================="
        echo "PostgreSQL Backup Service başlatıldı"
        echo "Bağlantı: ${PGUSER}@${PGHOST}:${PGPORT}/${PGDATABASE}"
        echo "========================================="
        echo "İlk yedekleme başlatılıyor..."

        /usr/local/bin/backup-postgres.sh 2>&1 | tee -a /var/log/backup.log || echo "İlk yedekleme başarısız"

        echo "========================================="
        echo "Cronjob ayarlanıyor: Her gün saat 01:00"
        echo '0 1 * * * /usr/local/bin/backup-postgres.sh >> /var/log/backup.log 2>&1' > /etc/crontabs/root

        echo "Crond başlatılıyor..."
        crond -f -l 2
    healthcheck:
      test: [ "CMD-SHELL", "test -d /backups && pgrep crond" ]
      interval: 60s
      timeout: 10s
      retries: 3

  kopia:
    image: kopia/kopia:latest
    container_name: kopia
    hostname: kopia-server
    restart: unless-stopped
    ports:
      - "${KOPIA_PORT:-51515}:51515"
    environment:
      KOPIA_PASSWORD: ${KOPIA_PASSWORD}
      TZ: ${TZ:-Europe/Istanbul}
      USER: kopia
      KOPIA_PERSIST_CREDENTIALS_ON_CONNECT: "true"
      KOPIA_CHECK_FOR_UPDATES: "true"
    volumes:
      - kopia-config:/app/config
      - kopia-cache:/app/cache
      - kopia-logs:/app/logs
      - postgres-backups:/data/postgres-dumps:ro
      - ${POSTGRES_VOLUME_PATH}:/data/postgres-volume:ro
      - ${MINIO_VOLUME_PATH}:/data/minio:ro
      - ${SSH_KEYS_PATH:-./ssh-keys}:/root/.ssh:ro
    depends_on:
      - postgres-backup
    command: >
      server start --insecure --address=0.0.0.0:51515 --server-username=admin --server-password=${KOPIA_PASSWORD} --override-hostname=kopia-server --override-username=kopia
    healthcheck:
      test: [ "CMD", "kopia", "server", "status" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  postgres-backups:
    driver: local
  kopia-config:
    driver: local
  kopia-cache:
    driver: local
  kopia-logs:
    driver: local

networks:
  default:
    external: true
    name: ${POSTGRES_NETWORK:-arsiv-server-app_arsiv_network}
